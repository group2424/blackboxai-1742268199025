{% extends "base.html" %}

{% block title %}Deposit{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-8">Deposit Funds</h1>

    <!-- Mobile Money Options -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
        <!-- MTN Mobile Money -->
        <div class="bg-white rounded-lg shadow-lg p-6 border-t-4 border-yellow-400">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold">MTN Mobile Money</h2>
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/93/New_MTN_logo.svg/200px-New_MTN_logo.svg.png" 
                     alt="MTN Logo" class="h-8">
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-600 mb-2">Account Name</label>
                    <div class="bg-gray-50 p-3 rounded font-semibold">
                        IRADUKUNDA ALINE
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-600 mb-2">Phone Number</label>
                    <div class="bg-gray-50 p-3 rounded font-semibold flex items-center justify-between">
                        <span>0795568955</span>
                        <button onclick="copyToClipboard('0795568955')" 
                                class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Airtel Money -->
        <div class="bg-white rounded-lg shadow-lg p-6 border-t-4 border-red-500">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold">Airtel Money</h2>
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/77/Airtel_logo.svg/200px-Airtel_logo.svg.png" 
                     alt="Airtel Logo" class="h-8">
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-600 mb-2">Account Name</label>
                    <div class="bg-gray-50 p-3 rounded font-semibold">
                        Xxx MURINDABIGWI
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-600 mb-2">Phone Number</label>
                    <div class="bg-gray-50 p-3 rounded font-semibold flex items-center justify-between">
                        <span>0729444928</span>
                        <button onclick="copyToClipboard('0729444928')" 
                                class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Form -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-semibold mb-6">Submit Deposit Details</h2>
        
        <form id="depositForm" class="space-y-6">
            <!-- Payment Method -->
            <div>
                <label class="block text-gray-600 mb-2">Payment Method</label>
                <div class="grid grid-cols-2 gap-4">
                    <label class="relative">
                        <input type="radio" name="payment_type" value="mtn" class="sr-only peer" required>
                        <div class="border rounded-lg p-4 cursor-pointer peer-checked:border-yellow-400 peer-checked:bg-yellow-50">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-yellow-400 mr-2 opacity-0 peer-checked:opacity-100"></i>
                                MTN Mobile Money
                            </div>
                        </div>
                    </label>
                    
                    <label class="relative">
                        <input type="radio" name="payment_type" value="airtel" class="sr-only peer" required>
                        <div class="border rounded-lg p-4 cursor-pointer peer-checked:border-red-500 peer-checked:bg-red-50">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-red-500 mr-2 opacity-0 peer-checked:opacity-100"></i>
                                Airtel Money
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Amount -->
            <div>
                <label for="amount" class="block text-gray-600 mb-2">Amount (RWF)</label>
                <input type="number" id="amount" name="amount" min="1000" 
                       class="w-full p-3 border rounded focus:ring-2 focus:ring-blue-600 focus:border-transparent"
                       placeholder="Enter amount (minimum 1,000 RWF)" required>
            </div>

            <!-- Transaction Reference -->
            <div>
                <label for="reference" class="block text-gray-600 mb-2">Transaction Reference</label>
                <input type="text" id="reference" name="reference" 
                       class="w-full p-3 border rounded focus:ring-2 focus:ring-blue-600 focus:border-transparent"
                       placeholder="Enter transaction reference/ID" required>
            </div>

            <!-- Submit Button -->
            <button type="submit" 
                    class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition">
                Submit Deposit
            </button>
        </form>
    </div>

    <!-- Instructions -->
    <div class="mt-8 bg-blue-50 rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">How to Deposit</h2>
        <ol class="list-decimal list-inside space-y-3 text-gray-700">
            <li>Choose your preferred payment method (MTN Mobile Money or Airtel Money)</li>
            <li>Send the amount you wish to deposit to the provided number</li>
            <li>Copy the transaction reference/ID from your mobile money message</li>
            <li>Fill in the deposit form with the amount and transaction reference</li>
            <li>Submit the form and wait for admin approval (usually within 30 minutes)</li>
        </ol>
    </div>

    <!-- Recent Deposits -->
    <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-semibold mb-6">Recent Deposits</h2>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Payment Method</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200" id="recentDeposits">
                    <!-- Deposits will be loaded here via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Copy to clipboard function
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show feedback
        const button = event.currentTarget;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
            button.innerHTML = originalHTML;
        }, 2000);
    });
}

// Handle form submission
document.getElementById('depositForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        payment_type: document.querySelector('input[name="payment_type"]:checked').value,
        amount: document.getElementById('amount').value,
        reference: document.getElementById('reference').value
    };
    
    try {
        const response = await fetch('/api/deposit/mobile-money', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('Deposit request submitted successfully!');
            loadRecentDeposits();
            e.target.reset();
        } else {
            alert(data.error || 'Failed to submit deposit request');
        }
    } catch (error) {
        alert('An error occurred. Please try again.');
    }
});

// Load recent deposits
async function loadRecentDeposits() {
    try {
        const response = await fetch('/api/deposit/history');
        const deposits = await response.json();
        
        const tbody = document.getElementById('recentDeposits');
        tbody.innerHTML = deposits.map(deposit => `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${deposit.amount.toLocaleString()} RWF
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${deposit.payment_type === 'mtn' ? 'MTN Mobile Money' : 'Airtel Money'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                        ${deposit.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 
                          deposit.status === 'approved' ? 'bg-green-100 text-green-800' : 
                          'bg-red-100 text-red-800'}">
                        ${deposit.status}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${new Date(deposit.timestamp).toLocaleString()}
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Failed to load recent deposits:', error);
    }
}

// Load deposits when page loads
loadRecentDeposits();
</script>
{% endblock %}
{% endblock %}
